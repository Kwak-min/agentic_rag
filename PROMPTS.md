# 프롬프트 설정 가이드

이 문서는 AgenticRAG 시스템의 모든 프롬프트 위치와 수정 방법을 안내합니다.

## 📍 프롬프트 위치 맵

### 1. 응답 생성 프롬프트 (일반 대화)
**파일**: `core/response_generator.py`
**위치**: 70-105행
**용도**: 도구를 사용하지 않는 일반 대화 응답 생성
**모델**: Ollama qwen2.5:7b

```python
chat_prompt = f"""<ROLE>
당신은 사용자의 질문에 대해 체계적이고 유용한 답변을 제공하는 전문 AI 어시스턴트입니다.
</ROLE>

<INSTRUCTIONS>
- 사용자의 질문을 명확히 파악하고, 그에 대한 직접적인 답변으로 시작해야 합니다.
- 답변, 상세 설명, 도움말 순서의 구조를 반드시 준수하여 응답을 작성하십시오.
- 정보가 불확실할 경우, 추측하지 말고 "해당 정보는 제가 가지고 있지 않아 답변드리기 어렵습니다."라고 명확히 밝히십시오.
- 전문적이면서도 이해하기 쉬운 어조를 사용하십시오.
</INSTRUCTIONS>

<FORMATTING_RULES>
- 제목: 메인 제목은 ##, 서브 제목은 ###를 사용하십시오.
- 목록: 순서 없는 목록은 -, 순서 있는 목록은 1.로 시작하십시오.
- 강조: 중요한 내용은 **로 감싸십시오.
- **중요**: 제목에는 절대 이모지를 사용하지 마십시오.
- **중요**: 답변에 코드 블록(```)을 절대 포함하지 마십시오.
</FORMATTING_RULES>

<REQUIRED_STRUCTURE>
## 답변
[사용자 질문에 대한 핵심적이고 직접적인 답변을 여기에 작성하십시오.]

### 상세 설명
[답변에 대한 구체적인 정보, 배경, 예시 등을 논리적으로 설명하십시오.]

### 도움말
[사용자에게 도움이 될 만한 추가 팁, 관련 정보, 권장 사항 등을 제안하십시오.]
</REQUIRED_STRUCTURE>

<CONTEXT>
사용자 질문: {user_query}
</CONTEXT>

이제 위의 지시사항과 구조를 엄격히 준수하여 답변을 생성하십시오:
"""
```

**수정 방법**:
1. `core/response_generator.py` 파일 열기
2. 70-105행 찾기
3. `chat_prompt` 변수 내용 수정
4. 백엔드 재시작: `docker-compose -f docker-compose-new.yml restart backend`

---

### 2. 도구 실행 결과 기반 응답 프롬프트
**파일**: `core/response_generator.py`
**위치**: 141-245행
**용도**: 도구 실행 결과를 바탕으로 구조화된 응답 생성
**모델**: Ollama qwen2.5:7b

```python
retrieval_guard_prompt = f"""<ROLE>
당신은 주어진 도구 실행 결과를 분석하여, 사용자의 질문에 대한 사실 기반의 보고서를 생성하는 데이터 분석 전문가입니다.
</ROLE>

<CRITICAL_RULES>
1. **절대 금지**: 도구 실행 결과에 없는 정보를 추가하거나 추측하지 마십시오.
2. **필수 준수**: 아래 구조를 정확히 따르십시오.
3. **완전성**: 도구 결과의 모든 관련 정보를 빠짐없이 포함하십시오.
</CRITICAL_RULES>

<REQUIRED_STRUCTURE>
## 핵심 요약
[질문에 대한 직접적이고 명확한 답변]

### 상세 정보
[구체적인 수치, 상태, 결과 등을 표나 목록으로 제시]

### 추가 정보
[관련 배경, 해석, 권장사항 등]

### 출처
[데이터 소스, 파일명, 시간 등]
</REQUIRED_STRUCTURE>

<FORMATTING_RULES>
- 제목: ## (메인), ### (서브) - 이모지 사용 금지
- 표: | 헤더1 | 헤더2 |로 시작
- **중요**: 코드 블록(```)을 절대 사용하지 마십시오.
</FORMATTING_RULES>

<CONTEXT>
사용자 질문: {user_query}
도구 실행 결과:
{formatted_results}
</CONTEXT>

위 정보만을 사용하여 구조화된 마크다운 보고서를 생성하십시오:
"""
```

**수정 방법**:
1. `core/response_generator.py` 파일 열기
2. 141-245행 찾기
3. `retrieval_guard_prompt` 변수 내용 수정
4. 백엔드 재시작

---

### 3. 자율 에이전트 시스템 프롬프트 (펌프 제어)
**파일**: `services/autonomous_agent.py`
**위치**: 69-117행
**용도**: 자율 모니터링 시스템의 펌프 제어 결정
**모델**: Ollama qwen2.5:7b (일반 대화와 동일)

```python
self.system_prompt = """
운영 규칙 및 펌프 제어 로직:

[저수지 목록]
저수지1: 가곡 저수지 (reservoir_id="gagok")
저수지2: 해룡 저수지 (reservoir_id="haeryong")

[제어 규칙 - 수위 기준]
1. 가곡 수위 < 40m → 저수지1 펌프 ON (PUMP_ON)
2. 가곡 수위 > 80m → 저수지1 펌프 OFF (PUMP_OFF)
3. 해룡 수위 < 40m → 저수지2 펌프 ON (PUMP_ON)
4. 해룡 수위 > 80m → 저수지2 펌프 OFF (PUMP_OFF)

[주의] 여러 저수지에 대해 동시 결정을 내려도 된다. 조건이 모호하면 actions에 이유를 포함한다.

[응답 예시]
입력: 가곡=30m, 해룡=85m
출력:
{
  "decision": "PUMP_CONTROL",
  "actions": [
    {"reservoir_id": "gagok", "action": "PUMP_ON", "reason": "가곡 30m < 40m"},
    {"reservoir_id": "haeryong", "action": "PUMP_OFF", "reason": "해룡 85m > 80m"}
  ],
  "message": "가곡 ON, 해룡 OFF"
}

입력: 가곡=10m, 해룡=50m
출력:
{
  "decision": "PUMP_CONTROL",
  "actions": [
    {"reservoir_id": "gagok", "action": "PUMP_ON", "reason": "가곡 10m < 40m"}
  ],
  "message": "가곡 ON"
}

입력: 가곡=50m, 해룡=50m
출력:
{
  "decision": "STABLE",
  "actions": [],
  "message": "안정"
}

JSON만 출력한다.
"""
```

**수정 방법**:
1. `services/autonomous_agent.py` 파일 열기
2. 69-117행 찾기
3. `self.system_prompt` 변수 내용 수정
4. 백엔드 재시작

**주의사항**:
- 이 프롬프트는 자동화 시스템에서 사용되므로 신중하게 수정하세요
- 수위 임계값(40m, 80m)을 변경할 때는 실제 시스템 요구사항에 맞춰야 합니다
- JSON 출력 형식을 반드시 유지해야 합니다

---

### 4. 레거시 응답 생성 프롬프트 (config.py)
**파일**: `config.py`
**위치**: 475-518행
**용도**: 구버전 응답 생성 (현재는 사용되지 않을 수 있음)

```python
RESPONSE_GENERATION_PROMPT = """
당신은 전문적인 AI 어시스턴트입니다. 도구 실행 결과를 바탕으로 구조화되고 명확한 한국어 답변을 제공하세요.

핵심 원칙:
1. **정확성**: 도구 결과에 있는 정보만 사용, 추측 금지
2. **구조화**: 반드시 아래 구조를 따라 답변
3. **완전성**: 모든 관련 정보를 빠짐없이 포함
4. **가독성**: 명확하고 이해하기 쉬운 형태로 제시

필수 답변 구조 (반드시 이 순서로 작성):
## 핵심 요약
[질문에 대한 직접적이고 명확한 답변]

### 상세 정보
[구체적인 수치, 상태, 결과 등을 표나 목록으로 제시]

### 추가 정보
[관련 배경, 해석, 권장사항 등]

### 출처
[데이터 소스, 파일명, 시간 등]

형식 규칙:
- 제목: ## (메인), ### (서브) - 이모지 사용 금지
- 목록: - (불릿), 1. (번호)
- 표: | 헤더1 | 헤더2 |
      | 값1   | 값2   |
- 강조: **중요내용**, *기울임*
- 이모지: 제목에 절대 사용하지 말고, 본문에서만 최소한 사용
- 코드블록(```) 절대 사용 금지

특별 처리 가이드:
- **수위 데이터**: 배수지별 수치를 표로 명확히 구분
- **시간 데이터**: 구체적인 시간대와 변화 추이를 표로 제시
- **오류 상황**: 오류 원인과 해결 방법을 구조화하여 제시
- **예측 결과**: 신뢰도와 함께 결과를 표로 정리
- **벡터 검색**: 검색된 문서 내용을 인용 형식으로 제시

입력 정보:
- 사용자 질문: {user_query}
- 도구 실행 결과: {tool_results}

출력: 위 구조를 정확히 따라 구조화된 마크다운 답변을 작성하세요.
"""
```

**수정 방법**:
1. `config.py` 파일 열기
2. 475-518행 찾기
3. `RESPONSE_GENERATION_PROMPT` 변수 내용 수정
4. 백엔드 재시작

---

## 🔧 프롬프트 수정 시 주의사항

### 1. 형식 유지
- 마크다운 형식 지시사항은 유지하세요 (##, ###, -, **, | 등)
- 코드 블록(```) 금지 규칙은 UI 렌더링을 위해 필수입니다

### 2. 구조 유지
- `<ROLE>`, `<INSTRUCTIONS>`, `<CONTEXT>` 등의 XML 태그는 프롬프트 구조화에 중요합니다
- 변수 플레이스홀더 (`{user_query}`, `{formatted_results}` 등)는 반드시 유지하세요

### 3. 일관성
- 여러 프롬프트를 수정할 때는 톤과 스타일을 일관되게 유지하세요
- 용어 사용을 통일하세요 (예: "배수지" vs "저수지")

### 4. 테스트
- 프롬프트 수정 후 반드시 테스트하세요
- 다양한 질문 유형으로 응답 품질을 확인하세요

### 5. 모델 특성 고려
- Ollama qwen2.5:7b는 한국어 지원이 우수합니다
- 간결하고 명확한 지시사항이 효과적입니다
- JSON 출력이 필요한 경우 명확하게 형식을 지정하세요

---

## 🚀 프롬프트 적용 방법

### 개발 환경 (로컬)
```bash
# 1. 파일 수정
vim core/response_generator.py  # 또는 원하는 에디터

# 2. 백엔드 재시작
docker-compose -f docker-compose-new.yml restart backend

# 3. 로그 확인
docker logs -f synergy-backend
```

### 운영 환경
1. 변경 사항을 Git에 커밋
2. 서버에서 Pull
3. 백엔드 재시작
4. 모니터링

---

## 📊 프롬프트 성능 평가

### 평가 기준
1. **정확성**: 요청한 정보를 정확하게 제공하는가?
2. **완전성**: 모든 관련 정보를 포함하는가?
3. **가독성**: 사용자가 이해하기 쉬운가?
4. **일관성**: 동일한 질문에 일관된 답변을 제공하는가?
5. **형식 준수**: 마크다운 형식을 올바르게 따르는가?

### 테스트 질문 예시
```
일반 대화:
- "안녕하세요"
- "오늘 날씨가 어때?"

도구 사용:
- "현재 가곡 저수지 수위는?"
- "지난 24시간 수위 변화를 보여줘"
- "펌프1을 켜줘"

복합 질문:
- "가곡과 해룡의 현재 상태를 비교해서 보고서를 만들어줘"
```

---

## 🔍 문제 해결

### 응답이 형식을 따르지 않을 때
1. 프롬프트에서 `<REQUIRED_STRUCTURE>` 섹션 강화
2. "반드시", "필수", "절대" 등의 강한 지시어 사용
3. 예시 추가

### 응답에 불필요한 정보가 포함될 때
1. `<CRITICAL_RULES>` 섹션에 금지 사항 명시
2. "도구 결과에 있는 정보만 사용" 강조

### JSON 파싱 오류 발생 시
1. "JSON만 출력한다" 명시
2. 정확한 JSON 형식 예시 제공
3. "설명이나 주석을 추가하지 마시오" 추가

---

## 📝 변경 이력 템플릿

프롬프트를 수정할 때마다 기록을 남기세요:

```markdown
### 2026-01-07
- **파일**: core/response_generator.py
- **변경 내용**: 일반 대화 프롬프트에 친근한 톤 추가
- **이유**: 사용자 피드백 - 너무 격식 있다는 의견
- **결과**: 만족도 향상
```

---

## 💡 프롬프트 엔지니어링 팁

1. **구체적으로**: 모호한 지시보다 구체적인 예시가 효과적
2. **제약 명시**: 하지 말아야 할 것을 명확히 표현
3. **구조화**: XML 태그나 섹션으로 프롬프트 구조화
4. **반복 강조**: 중요한 규칙은 여러 번 강조
5. **Few-shot**: 예시를 통해 원하는 출력 형식 제시

---

## 🔗 관련 파일

- `core/response_generator.py` - 응답 생성 로직
- `services/autonomous_agent.py` - 자율 에이전트
- `config.py` - 시스템 설정 및 레거시 프롬프트
- `models/ollama_client.py` - Ollama API 클라이언트
- `models/lm_studio.py` - LM Studio API 클라이언트
